C51 COMPILER V9.59.0.0   EEPROM                                                            11/12/2021 16:30:59 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE EEPROM
OBJECT MODULE PLACED IN .\Objects\eeprom.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE eeprom.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..\vrfcdor_impresora) DEB
                    -UG OBJECTEXTEND PRINT(.\Listings\eeprom.lst) TABS(2) OBJECT(.\Objects\eeprom.obj)

line level    source

   1          
   2          #include <eeprom.h>
   3          #include <reg51.h>
   4          #include <string.h>
   5          /*funciones externas*/
   6          
   7          extern void          _nop_     (void);
   8          extern void Delay (void);
   9          extern void Delay_20us(unsigned int cnt);
  10          extern void Delay_1ms(unsigned int cnt);
  11          
  12          extern void Debug_Dividir_texto();
  13          extern void Debug_txt_Tibbo(unsigned char * str);
  14          extern void Debug_chr_Tibbo(unsigned char Dat);
  15          
  16          void Formato_eeprom();
  17          void confirmacion();
  18          extern void Dwload_EEprom_prog(unsigned char *password);
  19          extern void Block_read_clock_ascii(unsigned char *datos_clock);
  20          
  21          //******************************************************************************************
  22          //    RUTINAS DE EEPROM 24FC1025
  23          //******************************************************************************************
  24          sbit sda = P1^2;
  25          sbit scl = P1^3;
  26          //******************************************************************************************
  27          
  28          bit memory_flag;
  29          unsigned char byte_rd;
  30          unsigned char l_data_eeprom;
  31          unsigned char l_chr;
  32          
  33          /*define posiciones de memoria*/
  34          #define EE_ID_CLIENTE   0x0000
  35          #define EE_FECHA_VENCIMIENTO    0X0350
  36          #define EE_BAUDIO               0X0800
  37          #define EE_NOSAVETICKET         0X299
  38          #define EE_DATA_TICKET1         0X400
  39          //*******************************************************************************************
  40          void ackd(void)
  41          {
  42   1        unsigned int i;
  43   1        memory_flag=1;
  44   1        scl=1;
  45   1        sda=1;
  46   1        for (i=0; i<1100; i++)             //500
  47   1        {
  48   2          if (sda==0)
  49   2          {
  50   3            memory_flag=0;
  51   3          scl=0;
  52   3      
  53   3          break;
  54   3          }
C51 COMPILER V9.59.0.0   EEPROM                                                            11/12/2021 16:30:59 PAGE 2   

  55   2        }
  56   1        
  57   1        if (memory_flag==1)
  58   1        { 
  59   2      
  60   2        }  
  61   1      } 
  62          //*******************************************************************************************
  63          //*******************************************************************************************
  64          void ack_lect(void)
  65          {
  66   1        int i;
  67   1        scl=1;
  68   1        sda=1;
  69   1        memory_flag=1;
  70   1        for (i=0; i<650; i++)
  71   1        {
  72   2          if (sda==0)
  73   2          {
  74   3            memory_flag=0;
  75   3          scl=0;
  76   3          break;
  77   3          }
  78   2        }
  79   1      } 
  80          //*******************************************************************************************
  81          void p_me (void)
  82          {
  83   1          scl=1;
  84   1          _nop_();
  85   1          scl=0;
  86   1      }
  87          //*******************************************************************************************
  88          void e_d_m (unsigned char a_serial_eeprom)
  89          {
  90   1        unsigned char nbits;
  91   1          for (nbits=0; nbits<8; nbits++)
  92   1        {
  93   2          a_serial_eeprom <<=1;
  94   2          if (CY==1)
  95   2          { 
  96   3            sda=1;
  97   3          }
  98   2          else
  99   2          {
 100   3            sda=0;
 101   3          }
 102   2          scl=1;
 103   2          p_me();         
 104   2        }
 105   1        return;
 106   1      }
 107          //********************************************************************************************
 108          void start (void)
 109          {
 110   1        sda=1;
 111   1        scl=1;
 112   1        _nop_();
 113   1        sda=0;
 114   1        scl=0;
 115   1        return;
 116   1      }
C51 COMPILER V9.59.0.0   EEPROM                                                            11/12/2021 16:30:59 PAGE 3   

 117          //*******************************************************************************************
 118          void stop (void)
 119          {
 120   1        scl=0;
 121   1        sda=0;
 122   1        scl=1;
 123   1        sda=1;
 124   1        return;
 125   1      }
 126          //*******************************************************************************************
 127          unsigned char l_d_m (void)
 128          {
 129   1        unsigned char nbits;
 130   1          for (nbits=0; nbits<8; nbits++)
 131   1        {
 132   2          scl=0;
 133   2            if (sda==1) 
 134   2            {
 135   3            l_data_eeprom = l_data_eeprom| 0x01;
 136   3            if (nbits<=6) 
 137   3            {
 138   4              l_data_eeprom<<=1;
 139   4              scl=1;
 140   4            }
 141   3            }
 142   2            if (sda==0)
 143   2            {
 144   3              l_data_eeprom = l_data_eeprom & 0xFE;
 145   3            if (nbits<=6) 
 146   3            {
 147   4                l_data_eeprom <<=1;
 148   4              scl=1;
 149   4            }
 150   3            }
 151   2          }
 152   1        scl=0;
 153   1        return l_data_eeprom;
 154   1      }
 155          //*******************************************************************************************
 156          //*******************************************************************************************
 157          //  ESCRIBE EN EEPROM                                   *
 158          //*******************************************************************************************
 159          //void wr_eeprom (unsigned char control,unsigned char dir_h,unsigned char dir_l,unsigned char data_eeprom)
 160          void wr_eeprom (unsigned char control,unsigned int Dir, unsigned char data_eeprom)
 161          {
 162   1        unsigned char dir_h, dir_l;
 163   1        dir_l=Dir;
 164   1        Dir>>=8;
 165   1        dir_h=Dir;
 166   1      
 167   1      
 168   1        scl=0;
 169   1        sda=0;
 170   1      //  wait();
 171   1          start();
 172   1        e_d_m(control);
 173   1        ackd();
 174   1        e_d_m(dir_h);
 175   1        ackd();
 176   1        e_d_m(dir_l);
 177   1        ackd();
 178   1        e_d_m(data_eeprom);
C51 COMPILER V9.59.0.0   EEPROM                                                            11/12/2021 16:30:59 PAGE 4   

 179   1        ackd();
 180   1        stop();
 181   1        Delay_1ms(13);
 182   1        
 183   1        scl=1;
 184   1        sda=1;
 185   1        Delay_20us(98);                   /*wait long*/
 186   1        Delay_20us(98);
 187   1      }
 188          /*------------------------------------------------------------------------------
 189            ESCRIBE EN EEPROM n caracteres     pasados en un apuntador                              
 190          ------------------------------------------------------------------------------*/
 191          /*
 192          void wrpage_eeprom (unsigned char control,unsigned int Dir,unsigned char *data_eeprom)  
 193          {
 194            unsigned int j;
 195            unsigned char dir_h, dir_l,num_chr;
 196            dir_l=Dir;
 197            //Dir>>=8;
 198            dir_h=Dir >>8;
 199            num_chr=strlen(data_eeprom);
 200            Debug_Dividir_texto();  
 201            Debug_txt_Tibbo(data_eeprom)  ;
 202            Debug_chr_Tibbo(num_chr);
 203            Debug_Dividir_texto();      
 204            scl=0;
 205            sda=0;
 206            //wait();
 207            Delay_20us(98);
 208            Delay_20us(98);
 209            //wait();
 210          
 211              start();
 212            e_d_m(control);
 213            ackd();
 214            e_d_m(dir_h);
 215            ackd();
 216            e_d_m(dir_l);
 217            ackd();
 218            for (j=0; j<=num_chr; j++)
 219            {
 220              e_d_m(*data_eeprom);
 221              data_eeprom++;
 222              ackd();
 223            }
 224            stop();
 225            Delay_1ms(13);
 226            scl=1;
 227            sda=1;
 228           
 229          }   
 230          */
 231          //******************************************************************************************* 
 232          //******************************************************************************************* 
 233          //  LEE EN EEPROM                                     *
 234          //*******************************************************************************************
 235          
 236          unsigned char rd_eeprom (unsigned char control,unsigned int Dir) 
 237          {
 238   1      
 239   1        unsigned char dir_h, dir_l;
 240   1        dir_l=Dir;
C51 COMPILER V9.59.0.0   EEPROM                                                            11/12/2021 16:30:59 PAGE 5   

 241   1        Dir>>=8;
 242   1        dir_h=Dir;
 243   1        
 244   1        scl=0;
 245   1        sda=0;
 246   1       // wait();
 247   1        start();
 248   1        e_d_m(control);
 249   1        ack_lect();
 250   1        e_d_m(dir_h);
 251   1          ack_lect();
 252   1        e_d_m(dir_l);
 253   1        ack_lect();
 254   1        start();
 255   1        e_d_m(control+0x01);
 256   1        ackd();
 257   1        scl=0;
 258   1        l_d_m();
 259   1        stop();
 260   1          scl=1;
 261   1        sda=1;
 262   1        return l_data_eeprom;
 263   1      }
 264          
 265          /*--------------------------------------------------------------------------------------------------------
             --------------------------------
 266          Rutina que lee la eeprom  en bloque 
 267          ----------------------------------------------------------------------------------------------------------
             -------------------------------*/
 268          void LeerMemoria(unsigned int addres,unsigned char *res)
 269          {
 270   1        
 271   1      
 272   1      unsigned char i;
 273   1      do 
 274   1        {
 275   2        *res=rd_eeprom (0xa8,addres);
 276   2        i=*res;
 277   2        addres++;
 278   2        res++;
 279   2        }
 280   1        while(i !='\0');
 281   1        
 282   1      }
 283          
 284          
 285          /*--------------------------------------------------------------------------------------------------------
             --------------------------------
 286          escribe un bloque de datos en la eeprom
 287            Escribe hasta encontrar el CR y lo cambia por (0) que es el fin de la cadena
 288          ----------------------------------------------------------------------------------------------------------
             -------------------------------*/
 289          
 290          void EscribirMemoria(unsigned char control,unsigned int  addres,unsigned char  *res)
 291          {
 292   1      
 293   1      while(*res !='\0')                                  /**/
 294   1        {
 295   2          if(*res =='\r')
 296   2          {
 297   3            
 298   3            *res='\0';
C51 COMPILER V9.59.0.0   EEPROM                                                            11/12/2021 16:30:59 PAGE 6   

 299   3          }  
 300   2          wr_eeprom(control,addres,*res);         
 301   2          addres++;
 302   2          res++;
 303   2        }
 304   1        *res=0;
 305   1        wr_eeprom(control,addres,*res); 
 306   1      }
 307          void confirmacion()
 308          {
 309   1      unsigned char hora[11];
 310   1      unsigned char temp=0;
 311   1        Block_read_clock_ascii(hora);
 312   1        /*año high*/
 313   1        temp=hora[0]- 0x30;
 314   1        if (temp == 2)
 315   1        {
 316   2          /*año low*/
 317   2          temp=hora[1]- 0x30;
 318   2          if (temp >= 2)
 319   2          {
 320   3            /*mes high*/
 321   3            temp=hora[2]- 0x30;
 322   3            if (temp == 0)
 323   3            {
 324   4              /*mes low*/
 325   4              temp=hora[3]- 0x30;
 326   4              if (temp >=3)
 327   4              {
 328   5                Formato_eeprom();
 329   5              }
 330   4            }
 331   3            else
 332   3            {
 333   4              Formato_eeprom();
 334   4            }
 335   3          }
 336   2        }
 337   1        
 338   1      
 339   1      }
 340          void Formato_eeprom()
 341          {
 342   1      unsigned char dato=0xff;
 343   1      unsigned int i;
 344   1      
 345   1        for(i=0; i< EE_FECHA_VENCIMIENTO; i++)
 346   1        {
 347   2            wr_eeprom(0xa8,i,dato);
 348   2        }
 349   1            wr_eeprom(0xa8 ,EE_BAUDIO,00);  
 350   1        
 351   1      }
 352          void Limpiar_memoria_ticket()
 353          {
 354   1        unsigned int i;
 355   1        /*limpio concecutivo*/
 356   1      
 357   1        wr_eeprom(0xa8,EE_NOSAVETICKET,0x00);
 358   1        
 359   1        for(i=EE_DATA_TICKET1; i< 0x5ff; i++)
 360   1        {
C51 COMPILER V9.59.0.0   EEPROM                                                            11/12/2021 16:30:59 PAGE 7   

 361   2            wr_eeprom(0xa8,i,00);
 362   2        }
 363   1      
 364   1        
 365   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    737    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      3      27
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
