C51 COMPILER V9.59.0.0   VERPRINT                                                          10/15/2021 16:07:49 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE VERPRINT
OBJECT MODULE PLACED IN .\Objects\verprint.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE verprint.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..\vrfcdor_impresora) D
                    -EBUG OBJECTEXTEND PRINT(.\Listings\verprint.lst) TABS(2) OBJECT(.\Objects\verprint.obj)

line level    source

   1          #include <verprint.h>
   2          #include <string.h>
   3          #include <reg51.h>
   4          /*funciones prototipo externas */
   5          
   6          extern void Debug_txt_Tibbo(unsigned char * str);
   7          extern void DebugBufferMF(unsigned char *str,unsigned char num_char,char io);
   8          extern void Debug_chr_Tibbo(unsigned char Dat);
   9          extern void PantallaLCD(unsigned char cod_msg);
  10          extern void send_portERR(unsigned char cod_err);
  11          extern unsigned char  ValidaSensoresPaso(void);
  12          extern void clear_buffer();
  13          extern void Trama_print_cod_barras(unsigned char *msj,unsigned char vehiculo);
  14          extern void Cmd_LPR_Salida_print(unsigned char *msj,unsigned char vehiculo);
  15          
  16          
  17          /*variables externas*/
  18          extern unsigned char g_cEstadoComSoft;
  19          extern unsigned char g_cEstadoImpresion;
  20          extern unsigned char ValTimeOutCom;
  21          extern unsigned char buffer_ready;
  22          extern idata unsigned char rbuf [];
  23          extern  unsigned char g_cContByteRx;
  24          extern  unsigned char  USE_LPR;
  25          extern unsigned char Timer_wait;
  26          
  27          sbit lock = P1^7;           //Relevo 
  28          /*----------------------------------------------------------------------------
  29          tiempo de delay entre funciones
  30          ------------------------------------------------------------------------------*/
  31          
  32          #define   TIME_CARD         20    //50
  33          #define   TIME_RX           200   //
  34          #define   TIME_PLACA        55
  35          #define   TIME_PULSADOR     3
  36          
  37          /*----------------------------------------------------------------------------
  38          definicion de recepcion serial 
  39          ------------------------------------------------------------------------------*/
  40          
  41          #define  ESPERA_RX          0           //espera el primer cmd de recepcion del verificado 
  42          /*----------------------------------------------------------------------------
  43          Definiciones de sequencias de lectura de ticket 
  44          ------------------------------------------------------------------------------*/
  45          
  46          #define SEQ_INICIO            0X00  
  47          #define SEQ_LEECODIGO         0X01
  48          #define SEQ_SEND_SOFT         0X02
  49          #define SEQ_SEND_SOFT_QR      0x03
  50          #define SEQ_CMNCCN_PTO        0X04
  51          #define SEQ_REINTENTO         0X05
  52          /*---------------------------------------------------------------------------------
  53          definiciones de la pantalla
  54          -----------------------------------------------------------------------------------*/
C51 COMPILER V9.59.0.0   VERPRINT                                                          10/15/2021 16:07:49 PAGE 2   

  55          #define INGRESO                 0xFA
  56          #define BIENVENIDO              0XFE
  57          #define AUDIO_IN                0XA0    // RELE 1
  58          #define AUDIO_ENTER             0XA1    // RELE 2
  59          #define GRACIAS                 0XFF
  60          
  61          /*---------------------------------------------------------------------------------
  62          funcion que debuelve la posicion del inicio del primer caracter de numerico de 0 a 9
  63          -----------------------------------------------------------------------------------*/
  64          unsigned char num_num(unsigned char * p)  
  65          {
  66   1      unsigned char contador=0;
  67   1        while ((*p < 0x30)|| (*p > 0x39))
  68   1        {
  69   2          
  70   2          p++;
  71   2          contador++;
  72   2        }
  73   1        return contador;
  74   1      }   
  75          /*---------------------------------------------------------------------------------
  76          definiciones de la pantalla
  77          -----------------------------------------------------------------------------------*/
  78          unsigned char num_char(unsigned char * p,unsigned char chr) 
  79          {
  80   1      unsigned char contador=0;
  81   1        while (*p !=chr)
  82   1        {
  83   2          
  84   2          p++;
  85   2          contador++;
  86   2        }
  87   1        return contador;
  88   1      }   
  89          /*--------------------------------------------------------------------------------------------------------
             ------------------
  90          procedimiento que lee el codigo de barra o el QR
  91          SEQ_INICIO=00 se detecta la presencia vehicular 
  92          SEQ_QUEST_PRINT=1 si fue  presionado el boton 
  93          ----------------------------------------------------------------------------------------------------------
             ------------------*/
  94          
  95          void Lee_ticket(void)
  96          {
  97   1        static unsigned char paso_una_vez=0;
  98   1        static unsigned char Ticket[10];
  99   1        unsigned char temp,temp2,vehiculo;
 100   1        unsigned char *tipo_vehiculo;
 101   1        switch (g_cEstadoImpresion)
 102   1        {
 103   2          case SEQ_INICIO:
 104   2          /*detecta el vehiculo en el loop*/
 105   2            
 106   2          if (ValTimeOutCom==1)                                                                 /*tiempo de espera */
 107   2          {
 108   3            lock=0;
 109   3            
 110   3            if (ValidaSensoresPaso()!=0)                                                        /*pregunto q alla presencia vehicular*/
 111   3            {
 112   4              Debug_txt_Tibbo((unsigned char *) "\r\n\Vehiculo en el loop\r\n");                  /* se encuentra un sensor a
             -ctivo*/
 113   4              PantallaLCD(BIENVENIDO);                                                          /*msj acerque el ticket*/
C51 COMPILER V9.59.0.0   VERPRINT                                                          10/15/2021 16:07:49 PAGE 3   

 114   4              if(paso_una_vez==0)
 115   4              {
 116   5              send_portERR(AUDIO_IN);                                                           /*habilito el audio de entrada*/
 117   5              paso_una_vez=1;
 118   5              }                           
 119   4              ValTimeOutCom=TIME_RX;
 120   4              g_cEstadoImpresion=SEQ_LEECODIGO;                                                   /*volvemos a preguntar  */  
 121   4                    
 122   4              
 123   4            
 124   4            }
 125   3            else
 126   3              {
 127   4              Debug_txt_Tibbo((unsigned char *) "Vehiculo no en el loop\r\n\r\n");              /* no hay vehiculo en el lo
             -op*/
 128   4              paso_una_vez=0;                                               
 129   4              ValTimeOutCom=TIME_PULSADOR;
 130   4              g_cEstadoImpresion=SEQ_INICIO;                                                    /*volvemos a preguntar  */  
 131   4                    
 132   4              }
 133   3          }
 134   2          break;
 135   2      /*--------------------------------------------------------------------------------------------------------
             ------------------------------------
 136   2      SEQ_LEECODIGO 
 137   2      lee el dato en el pto serial del codigo qr
 138   2      ----------------------------------------------------------------------------------------------------------
             -------------------------------------*/    
 139   2          case SEQ_LEECODIGO:
 140   2            if ((ValTimeOutCom == 1)||(buffer_ready != 0))
 141   2            {
 142   3              if (buffer_ready == 1)
 143   3              {
 144   4                /*trama con codigo QR*/
 145   4                Debug_txt_Tibbo((unsigned char *) "trama del lector datalogic cod QR");             /*la respuesta es desco
             -nocida*/
 146   4                Debug_txt_Tibbo(rbuf);                                                              /*imprimo la trama recibida*/
 147   4                Debug_txt_Tibbo((unsigned char *) "\r\n");
 148   4                ValTimeOutCom=TIME_CARD;                                            
 149   4                g_cEstadoImpresion=SEQ_SEND_SOFT_QR ;   
 150   4                                                                                                    /* buffer del pto serie (0) inicia a esperar la trama*/
 151   4               
 152   4              }
 153   3              else if (buffer_ready == 2)
 154   3              {
 155   4                /*codigo de barras*/
 156   4                strcpy(Ticket,rbuf);                                                                /*salvo el buffer*/
 157   4                temp=strlen(rbuf);                                                                  /*longitud del buffer*/
 158   4                Ticket[temp-1]=0;
 159   4                if (temp>10)
 160   4                {
 161   5                clear_buffer();
 162   5                PantallaLCD(BIENVENIDO);
 163   5                ValTimeOutCom=TIME_RX;
 164   5                g_cEstadoImpresion=SEQ_LEECODIGO; 
 165   5                break;
 166   5                }
 167   4                /*COD DE BARRAS*/ 
 168   4                Debug_txt_Tibbo((unsigned char *) "trama del lector datalogic cod barras");           /*la respuesta es de
             -sconocida*/
 169   4                Debug_txt_Tibbo(Ticket);                                                                /*imprimo la trama recibida*/
 170   4                Debug_txt_Tibbo((unsigned char *) "\r\n");
C51 COMPILER V9.59.0.0   VERPRINT                                                          10/15/2021 16:07:49 PAGE 4   

 171   4                                                          
 172   4              
 173   4                                                                                        /* buffer del pto serie (0) inicia a esperar la trama*/
 174   4                
 175   4                g_cEstadoImpresion=SEQ_SEND_SOFT  ;   
 176   4              }
 177   3              else
 178   3              {
 179   4                /*respuesta incorrecta limpia buffer lee otra vez*/
 180   4                clear_buffer();
 181   4                paso_una_vez=0;
 182   4                buffer_ready=0;   
 183   4                Debug_txt_Tibbo((unsigned char *) "trama del lector datalogic no esta completa\r\n");             /*la resp
             -uesta es desconocida*/
 184   4                ValTimeOutCom=TIME_PULSADOR;
 185   4                g_cEstadoImpresion=SEQ_INICIO;  
 186   4                }
 187   3                      
 188   3            
 189   3              
 190   3            } 
 191   2          break;
 192   2          case SEQ_SEND_SOFT:
 193   2            
 194   2              /*codigo de barras*/
 195   2              Debug_txt_Tibbo((unsigned char *) "cod barras");  
 196   2              buffer_ready=0; 
 197   2              vehiculo='C';
 198   2              Trama_print_cod_barras(Ticket,vehiculo);
 199   2          
 200   2            if(USE_LPR)
 201   2              {
 202   3              Cmd_LPR_Salida_print(Ticket,vehiculo);                                                /*envio datos a Monitor*/
 203   3              }
 204   2              ValTimeOutCom=TIME_PLACA;
 205   2              g_cEstadoImpresion=SEQ_CMNCCN_PTO ;   
 206   2            
 207   2            
 208   2            break;
 209   2            
 210   2          case  SEQ_SEND_SOFT_QR:
 211   2            /*es un codigo QR*/
 212   2            //  ES = 0;                             /*inactivo pto serie y analizo el dato*/
 213   2            if (ValTimeOutCom==1)
 214   2            {
 215   3          
 216   3              Debug_txt_Tibbo((unsigned char *) "cod QR r\n");
 217   3              /*codigo qr*/
 218   3              buffer_ready=0;                     /*limpio el testigo de recepcion de datos serie*/
 219   3              
 220   3              temp=num_num(rbuf);                 /*funcion que pregunta donde empieza el primer numero del ticket*/
 221   3              temp2=num_char(rbuf+temp,'>');      /*busca un caracter en la trama*/
 222   3              if ((tipo_vehiculo=strstr(rbuf,"Carro"))!= 0) /*pregunto el tipo de vehiculo grabado en el codigo QR*/
 223   3                {
 224   4                vehiculo='C';
 225   4                }
 226   3              else
 227   3                {
 228   4                vehiculo='M';
 229   4                }
 230   3              Debug_txt_Tibbo((unsigned char *) "tipo de vehiculo: ");            /*msj tipo de vehiculo */
 231   3              Debug_chr_Tibbo(vehiculo);                                          /*caracter del tipo de vehiculo*/
C51 COMPILER V9.59.0.0   VERPRINT                                                          10/15/2021 16:07:49 PAGE 5   

 232   3              Debug_txt_Tibbo((unsigned char *) "\r\n");                          /*final de linea*/
 233   3              
 234   3              Debug_txt_Tibbo((unsigned char *) "longitud de la trama: \r\n");    /*msj longitud de la trama */
 235   3              Debug_chr_Tibbo(temp);                                              /*numero de inicio del ticket*/
 236   3              Debug_txt_Tibbo((unsigned char *) "\r\n");                          /*final de linea*/                          
 237   3              Debug_chr_Tibbo(temp2);                                             /*numero de caracteres del ticket*/
 238   3              Debug_txt_Tibbo((unsigned char *) "\r\n");                          /*final de linea*/
 239   3             
 240   3              Ticket[0]=0;
 241   3              if(temp== 0x0c)                                                     /*la trama debe iniciar en 0x0c*/
 242   3              { 
 243   4              strncpy(Ticket,rbuf+temp,temp2);                                    /*copio el numero de ticket*/
 244   4              Ticket[temp2]=0;                                                    /*finalizo la trama con (0)*/
 245   4                      
 246   4              Debug_txt_Tibbo(Ticket);                                            /*imprimo el numero de ticket*/
 247   4              Debug_txt_Tibbo((unsigned char *) "\r\n");                          /*final de linea*/
 248   4              
 249   4              
 250   4          
 251   4              Trama_print_cod_barras(Ticket,vehiculo);                            /*envio la trama al pto paralelo y es enviada al
             - principal el cual comunica con acces*/
 252   4              
 253   4              
 254   4              if(USE_LPR)
 255   4              {
 256   5              Cmd_LPR_Salida_print(Ticket,vehiculo);                                /*envio datos a Monitor*/
 257   5              }
 258   4              ValTimeOutCom=TIME_PLACA;
 259   4              g_cEstadoImpresion=SEQ_CMNCCN_PTO ; 
 260   4              break;
 261   4              }
 262   3              else
 263   3              {
 264   4                ES = 1;
 265   4                clear_buffer();
 266   4              //  PantallaLCD(BIENVENIDO);
 267   4                //send_portERR(TARJETA_INVALIDA);  
 268   4                ValTimeOutCom=TIME_RX;
 269   4                g_cEstadoImpresion=SEQ_LEECODIGO;   
 270   4              
 271   4              }
 272   3            }
 273   2                break;
 274   2          case SEQ_CMNCCN_PTO:
 275   2            if (ValTimeOutCom==1)
 276   2            {
 277   3              ES = 1;                                                                             /*habilito pto*/
 278   3              Debug_txt_Tibbo((unsigned char *) "fin de lectura de trama\r\n");                   /*la respuesta es desconoci
             -da*/
 279   3              //PantallaLCD(GRACIAS);
 280   3              ValTimeOutCom=TIME_PULSADOR;
 281   3              clear_buffer();
 282   3              paso_una_vez=0;      
 283   3              g_cEstadoImpresion=SEQ_INICIO;
 284   3            }
 285   2            break;
 286   2          default:
 287   2          g_cEstadoImpresion=SEQ_INICIO;
 288   2          break;
 289   2        
 290   2          case SEQ_REINTENTO:
 291   2            if (ValTimeOutCom==1)
C51 COMPILER V9.59.0.0   VERPRINT                                                          10/15/2021 16:07:49 PAGE 6   

 292   2            {
 293   3              Debug_txt_Tibbo((unsigned char *) "REENVIA TRAMA PTO PARALELO\r\n ");           /*msj tipo de vehiculo */
 294   3              
 295   3              Trama_print_cod_barras(Ticket,vehiculo);  
 296   3              ValTimeOutCom=TIME_PLACA;
 297   3              g_cEstadoImpresion=SEQ_CMNCCN_PTO ; 
 298   3            }
 299   2              break;    
 300   2        }
 301   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    807    ----
   CONSTANT SIZE    =    299    ----
   XDATA SIZE       =     11       6
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
